---
- name: download ipfs-cluster-ctl
  get_url:
    url: "{{ ipfs_cluster_ctl_binary_url }}"
    checksum: "sha512:{{ ipfs_cluster_ctl_binary_sha512 }}"
    dest: /tmp/ipfs-cluster-ctl.tar.gz
    mode: 0644
  register: ipfs_cluster_ctl_download
- name: Extract and install
  block:
    - name: extract ipfs-cluster-ctl
      unarchive:
        copy: false
        src: "{{ ipfs_cluster_ctl_download.dest }}"
        dest: /tmp/
    - name: install ipfs-cluster-ctl
      copy:
        remote_src: True
        src: /tmp/ipfs-cluster-ctl/ipfs-cluster-ctl
        dest: "{{ ipfs_cluster_ctl_binary }}"
        mode: 0755
    - name: remove ipfs-cluster-ctl temporary files
      file: state=absent path=/tmp/ipfs-cluster-ctl
  when: ipfs_cluster_ctl_download.changed
- name: Download ipfs-cluster-service
  get_url:
    url: "{{ ipfs_cluster_service_binary_url }}"
    checksum: "sha512:{{ ipfs_cluster_service_binary_sha512 }}"
    dest: /tmp/ipfs-cluster-service.tar.gz
    mode: 0644
  register: ipfs_cluster_service_download
- name: Extract and install
  block:
    - name: extract ipfs-cluster-service
      unarchive:
        copy: false
        src: "{{ ipfs_cluster_service_download.dest }}"
        dest: /tmp/
    - name: install ipfs-cluster-service
      copy:
        remote_src: True
        src: /tmp/ipfs-cluster-service/ipfs-cluster-service
        dest: "{{ ipfs_cluster_service_binary }}"
        mode: 0755
      notify: restart ipfs-cluster
    - name: remove ipfs-cluster-service temporary files
      file: state=absent path=/tmp/ipfs-cluster-service
    - name: Annotate
      include_role:
        name: annotate
      vars:
        role: cluster
        version: "{{ ipfs_cluster_service_binary_url }}"
        action: upgrade
  when: ipfs_cluster_service_download.changed
- name: Setup group
  group: name="{{ ipfs_cluster_group }}" system=true state=present
- name: Setup user
  user:
    name: "{{ ipfs_cluster_user }}"
    comment: "ipfs-cluster-service"
    group: "{{ ipfs_cluster_group }}"
    system: true
    state: present
    create_home: false
    home: "{{ ipfs_cluster_path }}"
    shell: /usr/sbin/nologin
- name: Setup homedir
  file:
    path: "{{ ipfs_cluster_path }}"
    owner: "{{ ipfs_cluster_user }}"
    group: "{{ ipfs_cluster_group }}"
    mode: 0750
    state: directory
- name: Creating identity.json
  template:
    src: identity.json
    dest: "{{ ipfs_cluster_path }}/identity.json"
    mode: 0400
    owner: "{{ ipfs_cluster_user }}"
    group: "{{ ipfs_cluster_group }}"
  notify: restart ipfs-cluster
# TODO: SECURITY: This requires that we trust ipify to provide the correct public IP. We could run our own ipify server.
- name: Get my public IP from ipify.org
  ipify_facts:
- name: Creating service.json
  template:
    src: service.json
    dest: "{{ ipfs_cluster_path }}/service.json"
    mode: 0644
  notify: restart ipfs-cluster
- name: Configure ipfs-cluster service
  template:
   src: ipfs-cluster.service
   dest: /etc/systemd/system/ipfs-cluster.service
   mode: 0644
  notify: restart ipfs-cluster
- name: Enable ipfs-cluster service
  systemd: name=ipfs-cluster daemon_reload=yes state=started enabled=yes
- name: Creating service.json for followers
  template:
    src: service-followers.json
    dest: "{{ ipfs_cluster_path }}/service-followers.json"
    mode: 0644
  register: service_followers
- name: Adding service-followers.json to cluster
  command: "ipfs-cluster-ctl add -n cluster-service -Q {{ ipfs_cluster_path }}/service-followers.json"
  environment:
    IPFS_CLUSTER_PATH: "{{ ipfs_cluster_path }}"
  become: true
  become_user: "{{ ipfs_cluster_user }}"
  when: service_followers.changed
  register: service_followers_cid
- name: Printing new cluster service file cid
  debug:
    msg: "Cluster service file: {{ service_followers_cid.stdout }}"
  when: service_followers.changed
