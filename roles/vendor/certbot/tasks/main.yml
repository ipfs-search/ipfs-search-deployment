---
- include_tasks: cloudflare-plugin.yml
- name: Update apt-get repo and cache
  apt: update_cache=yes cache_valid_time=3600
- name: Install installation deps
  apt:
    name: software-properties-common
    state: present
- name: install pip3
  apt: name=python3-pip state=present
- name: install certbot certbot-nginx certbot-dns-cloudflare
  command: pip3 install certbot certbot-nginx certbot-dns-cloudflare
- name: Setup certificates
  command: certbot certonly -a dns-cloudflare --dns-cloudflare-credentials ~/cloudflare.ini -i nginx {% if certbot_test %}--test-cert {% endif %}-m '{{ certbot_email }}' --agree-tos -n -d '{{ certbot_domains }}'
  changed_when: true
- name: Generate Diffie-Hellman params
  command: openssl dhparam -out {{ dh_params }} 4096
  args:
    creates: '{{ dh_params }}'
- name: Install nginx SSL params
  template:
    src: options-ssl-nginx.conf.j2
    dest: '{{ options_ssl_nginx }}'
    mode: 0644
  notify: Reload nginx
