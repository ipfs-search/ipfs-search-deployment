---
- name: Update apt repo and cache
  apt: update_cache=yes cache_valid_time=3600
- name: Install snapd
  apt:
    name: snapd
- name: Install certbot using snap
  snap:
    name: certbot
    classic: true
- name: Confirm plugin containment level 
  shell: snap set certbot trust-plugin-with-root=ok
- name: Install certbot cloudflare DNS plugin
  snap:
    name: certbot-dns-cloudflare
- name: Prepare Cloudflare credentials .ini file
  template:
    src: cloudflare.ini.j2
    dest: ~/cloudflare.ini
    mode: 0600
- name: Setup certificates
  command: certbot certonly -a dns-cloudflare --dns-cloudflare-credentials ~/cloudflare.ini -i nginx {% if certbot_test %}--test-cert {% endif %}-m '{{ certbot_email }}' --agree-tos -n -d '{{ certbot_domains }}'
  changed_when: true
- name: Generate Diffie-Hellman params
  command: openssl dhparam -out {{ dh_params }} 4096
  args:
    creates: '{{ dh_params }}'
- name: Install nginx SSL params
  template:
    src: options-ssl-nginx.conf.j2
    dest: '{{ options_ssl_nginx }}'
    mode: 0644
  notify: Reload nginx
