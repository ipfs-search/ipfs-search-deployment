---

- name: OpenSearch installation & configuration
  hosts: opensearch
  tags: opensearch
  become: true
  gather_facts: true
  serial: 1
  any_errors_fatal: true
  roles:
    - { role: vendor/opensearch }

# Currently disabled
# - name: opensearch dashboards installation & configuration
#   hosts: opensearch_dashboards
#   tags: dashboards
#   become: true
#   gather_facts: true
#   roles:
#     - { role: vendor/opensearch_dashboards }

- name: Enable promtail for Opensearch
  hosts: opensearch
  become: true
  serial: 1
  any_errors_fatal: true

  # NOTE: Comment out for clean installs!
  pre_tasks:
    - name: Ensure OS cluster health is green
      uri:
        url: http://localhost:9200/_cluster/health
        method: GET
      register: response
      until: "response.json.status == 'green'"
      retries: 1000
      delay: 2

  roles:
    - name: push logs files to loki using promtail
      role: vendor/promtail
      tags: promtail
      vars:
        os_logs_to_loki: true
